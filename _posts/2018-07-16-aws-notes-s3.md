---
layout: post
title: AWS Notes - Simple Storage Service (S3)
image: "assets/images/banner-1686944_1920.jpg"
---
## S3 Basics
* Object based storage, not block
* File sizes min: 0B to max: 5TB
* Bucket names must be globally unique, i.e. even though region would make
  DNS for bucket unique, the bucket names can't be same across multiple regions.
* Bucket DNS in form: https://s3-<region>.amazonaws.com/<bucket_name>
* When in default US-East 1 region (Virginia), S3 bucket DNS names do NOT
include the region name.  
* Read after write consistency for PUTs of new objects
* Eventual consistency for update PUTs and DELETEs
* Large files should use multi-part uploads
* Returns HTTP 200 on upload success
* S3 Endpoints return XML formatted errors on errors or permissioning problems
except 

## Storage Classes
* S3 Standard
* S3 IA (Infrequently accessed) - lower storage cost, charged for retrieval
* S3 One Zone IA - multiple devices, but only in a single availability zone
* Glacier - 3-5 hour retrieval time

## S3 Object Structure
* Key (name)
* Value (data)
* Version ID
* Metadata (mapped to HTTP response headers on GETs)
* Subresources
    * ACL
    * Torrent

## S3 Object Versioning
* Stores all versions of an object
* When you delete a file, S3 creates a delete marker. Previous versions are not
  actually deleted unless you specifically delete a particular version or expire
  previous versions using lifecycle management.
* S3 can use MFA for additional layer of security on DELETE operations
* Good for object level backup capability

## Cross Region Replication
* Requires versioning enabled for both source and destination buckets
* Source and destination regions must be unique
* Files pre-existing in a bucket when CRR is turned on will not replicate until
  they are changed. New files and updates will replicate automatically
* S3 CRR doesn't support multi-destination replication or chained replication
* Delete markers are replicated
* Deletion of specific versions or delete markers will not be replicated. If you delete
a particular version of a file in the source bucket, the corresponding version
in the target bucket is NOT deleted. Deletion of a file without version in the
source bucket will delete the file in target bucket, but remember that deleting a file
just creates a delete marker.  The object still exists. NOT replicating deletes for
specific versions thus ensures that malicious deletes to source bucket objects
don't cascade full deletion of objects in the replication target.

## S3 Lifeycle Management
* Can be used with or without Versioning
* Rules can be applied to current version or all previous versions, but not to
  specific previous versions only

### Transitions
* Transition to Standard IA after a minimum of 30 days in Standard
* Transition to Glacier after a minimum of 30 days in IA
* Expire and permanently delete objects

## Cloudfront CDN
* Edge locations are global locations where servers cache data, but not necessarily
  in standard AZs.  There are more than 50+ global edge locations
* Edge locations can be written to, not just read
* Objects have a cache TTL
* Objects that become stale before TTL expires can be manually purged, but that
  incurs additional cost
* Origin is the source of files in a distribution. Can be:
    * S3 bucket
    * EC2 Instance
    * Elastic Load Balancer (ELB)
    * Route 53
* Distribution is the collection of edge locations serving a given set of content
    * Web distribution - For Web sites or Web applications
    * RTMP - Used for Adobe Flash media streaming
* Transfer Acceleration uses Cloudfront to accelerate uploads

## Static Websites
* Use Route 53 to route custom domain to S3
* Bucket name has to match domain name
* Can configure one S3 bucket to redirect to another, for instance using
  domain apex bucket to redirect to a www subdomain
* Static Website endpoint URLs have form:
    http://<bucket>.s3-website-<region>.amazonaws.com/  
* The regular S3 endpoint has form:
    http://s3-<region>.amazonaws.com/<bucket>  


## S3 Security
* Buckets are PRIVATE by default
* Permissioning can be done either via ACLs or bucket policies
* ACLs can be done at object level
* Bucket policies can be done only at bucket level
* Should favor policies over ACLs when possible
* IAM policies also factor into permissions on S3
* S3 buckets can be configured to write access logs to another bucket in same or
  different AWS account

### Encryption
* In transit encryption uses SSL/TLS
* At rest encryption
    * S3 Managed keys (SSE-S3)
        * AES-256
        * Amazon manages encryption keys for each object and encrypt each key with
        rotated master key
    * AES Key Management service (SSE-KMS)
        * Similar to SSE-S3
        * Separate permissions for use of envelope key
        * Provides audit trail of key use
        * Allows you to create keys yourself or use default
        * Incurs additional cost
    * Customer provided keys (SSE-C)
    * Client side encryption - do it yourself prior to uploading to S3

## Storage Gateway
* Service connecting on-premises software appliance with cloud based storage
* Virtual appliance installed in a hypervisor in customer DC
* Supports either VMWare ESXi or MS Hyper-V

### Storage Gateway Types
* File Gateway (new)
* Volume Gateway
    * Stored volumes
    * Cached volumes
* Tape Gateway

#### File Gateway (NFS)
* Store flat files directly in S3
* Accessed through a NFS mount point
* Once in S3 the files can take advantage of all S3 capabilities for life cycle
  management
* Storage gateway can connect over internet, over Direct Connect, or within VPC

#### Volume Gateway (iSCSI)
* Block based using iSCSI block protocol
* Data written can be async backed up as snapshots in S3
* Snapshots are incremental
* Two different types of volume gateways, stored and cached
* Stored volumes
    * Entire copy stored locally on-prem
    * Sizes from 1GB to 16TB
* Cached volumes
    * Keeping only most recently read data on-prem
    * Store in EBS (I think) and snapshots to S3
    * Sizes up to 32TB

#### Tape Gateway (VTL)
* Leverages existing tape backup infrastructure
* Create virtual tape cartridges on VTL
* Virtual tapes sent to S3
* Lifecycle policies to move/retrieve from virtual tape shelf in Glacier

## Snowball and Legacy Import/Export
## Import/Export
* Legacy, you send in your own disks
* Still available, but discouraged

### Snowball
* Petabyte scale secure appliance to which you write data and mail appliance back to AWS
* Support for up to 80TB

### Snowball Edge
* Up to 100TB
* Contains compute, not just storage
* Can run Lambda functions

### Snowmobile
* Semi-truck pulled Shipping container
* 100PB per snowmobile
