---
layout: post
title: AWS Notes - Networking
image: "assets/images/banner-1686944_1920.jpg"
---
Notes on Amazon Web Services VPC, Route 53 DNS, CloudFront CDN

## AWS Networking FAQs
* [Amazon VPC FAQ](https://aws.amazon.com/vpc/faqs/)
* [Amazon CloudFront FAQ](https://aws.amazon.com/cloudfront/faqs/)
* [Amazon Route 53 FAQ](https://aws.amazon.com/route53/faqs/)
* [Amazon API Gateway FAQ](https://aws.amazon.com/api-gateway/faqs/)
* [AWS Direct Connect FAQ](https://aws.amazon.com/directconnect/faqs/)
* [Elastic Load Balancing FAQ](https://aws.amazon.com/ec2/faqs/)

## Virtual Private Cloud (VPC)
* Virtual data center in the cloud
* Consists of Internet Gateways, Virtual Private Gateways, Route Tables, NACLS, Subnets, ad Security Groups
* An Internet gateway is horizontally-scaled, redundant, and highly available. It imposes no bandwidth constraints
* 1 Subnet -> 1 Availability Zone
* Security Groups are stateful
* Network Access Control Lists are stateless
* When creating a new VPC, AWS will automatically create a default Route table, default NACLs, and default security group. It won't automatically create any subnets or gateways
* AWS randomizes availability zone naming per account, so what's zone A in one account may not be the same zone as zone A in another account. It does this to evenly distribute across all actual zones

### NAT Instances
* When creating a NAT instance, need to disable source/destination check
* NAT instances must be in public subnet
* Route table for private subnet needs a route out through NAT instance as target
* Amount of traffic that a NAT instance can support depends on instance size. If bottlenecking, increase to large instance sizes for NAT
* You can create HA using autoscaling groups, multiple subnets in different AZs, and a script to automate failover
* ...but that's a pain to manage yourself, so use NAT gateways instead

### NAT Gateways
* NAT Gateways are the newer AWS managed NAT as a service. They are much preferable to manually configured NAT instances in that they are auto-scaled, resilient, auto-patched, more secure. NAT Gateways aren't free though.
* Still should create NAT Gateways in multiple AZs
* Scales up to 10Gbps
* No need to disable source/dest checks
* Not associated with a security group

### Network Access Control Lists (NACLs)
* A subnet can only be associated with one NACL
* A NACL can't span multiple VPCs
* The default NACL created for a VPC allows everything through, but any new NACL you create yourself will deny everything by default
* NACLs are stateless, meaning you have to specifically configure both inbound and outbound side of any given communication.  For instance, when configuring a NACL to allow HTTP traffic, in addition to enabling port 80 TCP access  on inbound side, you have to enable outbound traffic coming targeting ephemeral ports
* When numbering NACL rules, the lower numbered rule will take precedence.  For instance if you have rule 100 allowing HTTP from all IPs and rule 101 denying HTTP from your IP, your IP will still have access to HTTP.  You would need to rule the specific IP deny to 99 or lower to deny your IP
* NACLs controls will filter inbound traffic before security groups
* You can associate a NACL with multiple subnets, but a single subnet can be associated with only one NACL at a time.
* NACLs can be used to block specific IPs. Security groups can't do that.

### Elastic Load Balancers (ELB)
* Three types
    * Application LB - Layer 7
    * Network LB - Layer 4
    * Classic LB - Being phased out
* Creating an ELB requires multiple public subnets from at least two different AZs, meaning you need multiple internet gateways, as it's the attachment of IGWs and route from a subnet out through the IGW that makes a subnet "public"

### VPC Flow Logs
* VPC flow logs let you capture traffic going to and from network interfaces in your VPC
* Stored using CloudWatch logs
* Three levels of flow logs
    * VPC
    * Subnet
    * Network interface level
* You cannot enable flow logs for VPCs that are peered with your VPC unless the peer VPC is in your AWS account
* You cannot tag a flow log
*  After you've created a flow log, you can't change its configuration. If you need to change the IAM role associated with the flow log, you'd have to create a new flow log
* Not all IP traffic is monitored
    * Traffic generated by instances when they contact the Amazon DNS server.  If you use your own DNS server, then all traffic to that DNS server is logged.
    * Traffic generated by Windows instance for Amazon Windows license activation
    * Traffic to and from 169.254.169.254 for instance metadata
    * DHCP traffic
    * Traffic to the reserved IP address for the default VPC router

### VPC Endpoints
* VPC endpoints provide a way for VPC resources to access AWS services without having to be routed back out over the internet
* When creating an endpoint, you have to select which services you want access to.  Then you associate the endpoint with a particular (typically private) subnet and it will add routing table entry targeting the VPC endpoint
* Two types of VPC endpoints
    * Interfaces
    * Gateways - built in redundancy
* AWS services will see private IP as origin IP

## Route 53
* Route 53 is a global service, config is for all regions
* AWS limits you to 50 domain names / hosted zones, but you can get the limit raised by contacting AWS
* AWS supports IPv6 in Route63 and VPC
* Need Alias record to map zone apex to ELB because CNAMEs don't support zone apex and ELB only ever gives DNS, not an IP
* Route 53 charges for CNAME resolution request, but not for Alias record
* DNS record types
    * SOA (Start of Authority)
        * Name of server that supplied the data for the zone
        * administrator of the zone
        * Current version of the data file
        * Number of seconds a secondary name server should wait before checking for updates
        * Number of seconds a secondary name server should wait before retrying a failed zone transfer
        * Maximum number of seconds a secondary name server can use data before it must either refresh or expire
        * Default number of seconds for the TTL file on resource records
    * NS (Name server) - Used by top level domain servers to direct traffic to the content DNS server which contains the authoritative DNS records
    * A (Address) - Translates a name to an IP address
    * CNAME (Canonical Name)
        * Resolve one name to another.
        * Can't use with for zone apex
    * Alias record - Like CNAME, but can be used to map a zone apex record
    * MX - Mail records
    * TXT
    * SPF - Don't use this.  Use TXT records for SPF/anti-spoofing
* You never get an IP address for an ELB
* DNS uses port 53, thus the name Route 53

### Route 53 Routing Policies
* Simple
    * Default
    * Round robin
* Weighted
    * Weight routing between multiple regions or between different ELBs in the same region
    * Weighting happens over longer period of time throughout day, not at level of seconds or minutes
    * Requires a record (usually Alias or A) for each target and specify a number representing weight, but that number is a percent.  All numbers for same domain are added and then the number for a particular record divided by total to figure the weighting
    * Good for if you want to test new site features on a certain percentage of users
* Latency
    * Route traffic based on lowest network latency for your end user
    * When creating records for latency routing, have to specify the region, even though AWS should know region for AWS targets
* Failover
    * Used for active/passive
    * A healthcheck monitors health of endpoints
    * Requires setup of healthcheck
    * Healthcheck should be specifically for the primary region target
    * Must specify either primary or secondary on each record
    * Failover record doesn't need to specify a healthcheck
* Geolocation
    * Chooses where to route traffic based on geographic location of users
    * Can specify targets based on continents, countries, or even by state for US users

## Cloudfront CDN
* Edge locations are global locations where servers cache data, but not necessarily
  in standard AZs.  There are more than 50+ global edge locations
* Edge locations can be written to, not just read
* Objects have a cache TTL
* Objects that become stale before TTL expires can be manually purged, but that
  incurs additional cost
* Origin is the source of files in a distribution. Can be:
    * S3 bucket
    * EC2 Instance
    * Elastic Load Balancer (ELB)
    * Route 53
* Distribution is the collection of edge locations serving a given set of content
    * Web distribution - For Web sites or Web applications
    * RTMP - Used for Adobe Flash media streaming
* Transfer Acceleration uses Cloudfront to accelerate uploads
